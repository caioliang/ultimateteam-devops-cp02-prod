<!DOCTYPE html>
<html lang="en" data-theme="halloween" xmlns:th="http://www.thymeleaf.org">
<head>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5/themes.css" rel="stylesheet" type="text/css" />
    <meta charset="UTF-8">

    <title th:text="#{attendance.grid.title}"></title>

    <style>
        table {
            border-collapse: collapse;
            border-spacing: 0;
        }

        td {
            padding: 0 !important;
        }

        td.sticky.left-0 {
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            position: relative;
        }

        td.sticky.left-0::after {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            width: 2px;
            height: 100%;
            background: rgba(255,255,255,0.1);
            z-index: 5;
        }

        .editable-cell {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            font-weight: 700;
            text-transform: uppercase;
            padding: 0.5rem 0.75rem;
            height: 100%;
            min-height: 3rem;
            width: calc(100% + 2px);
            margin: -1px;
            z-index: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border-radius: 0;
            transition: background-color .15s ease, color .15s ease;
        }
        .editable-cell:hover { cursor: pointer; opacity: 0.9; }

        td:last-child .editable-cell {
            margin-right: 0;
            width: calc(100% + 1px);
        }

        :root { --page-bg: oklch(21% .006 56.043); }
        body { background: var(--page-bg); }

        .status-PRESENTE   { background-color: #22c55e !important; color: var(--page-bg) !important; }
        .status-AUSENTE    { background-color: #ef4444 !important; color: var(--page-bg) !important; }
        .status-NAO_ERA    { background-color: #6b7280 !important; color: var(--page-bg) !important; }
        .status-INDEFINIDO { background-color: #f59e0b !important; color: var(--page-bg) !important; }

        tbody tr td { height: 48px; }

        th { padding: 0.5rem 0.75rem !important; }

        .sortable {
            cursor: pointer;
            position: relative;
        }
        .sort-icon {
            margin-left: 0.5rem;
            display: inline-block;
        }
        .sorted {
            font-weight: bold;
        }
    </style>
</head>

<body>
<div th:insert="~{_navbar :: navbar}"></div>
<main class="min-h-screen flex justify-center pt-8 px-4">
    <div class="w-full max-w-7xl mx-auto p-4">

        <h1 class="text-6xl font-bold mb-8 text-center uppercase" th:text="#{attendance.grid.title}"></h1>

        <div class="mb-6">
            <input type="text" id="filter-player-name" onkeyup="filterPlayerNames()"
                   th:placeholder="#{attendance.grid.filter.placeholder}"
                   class="input input-bordered w-full max-w-xs bg-base-100 text-base-content capitalize" />
        </div>
        <div class="overflow-x-auto w-full">
            <div class="inline-block min-w-max">
                <table class="table table-pin-rows" id="attendance-table">
                    <thead>
                    <tr>
                        <th class="text-center text-lg font-bold w-48 py-2 bg-base-300 border-r border-base-content/20 sortable" onclick="sortTable(0)">
                            <div class="flex items-center justify-center whitespace-nowrap uppercase">
                                <span th:text="#{attendance.grid.column.player}"></span> <span class="sort-icon" id="sort-arrow-0"></span>
                            </div>
                        </th>

                        <th th:each="training, stat : ${trainings}"
                            th:id="'header-' + ${stat.index + 1}"
                            class="text-center w-28 py-2 border-base-content/20 bg-base-300 sortable"
                            th:classappend="${!stat.last} ? 'border-r' : ''"
                            th:onclick="'sortTable(' + (${stat.index + 1}) + ')'">

                            <div class="flex items-center justify-center h-full whitespace-nowrap">

                                <div class="flex flex-col items-center">
                                    <span class="block text-sm font-extrabold" th:text="${#temporals.format(training.date, 'dd/MM')}"></span>
                                    <span class="block text-xs" th:text="${training.location}"></span>
                                </div>

                                <span class="sort-icon ml-1" th:id="'sort-arrow-' + ${stat.index + 1}"></span>
                            </div>
                        </th>
                    </tr>
                    </thead>

                    <tbody>
                    <tr th:each="player : ${players}">

                        <td th:text="${player.name}" class="sticky left-0 bg-base-100 font-semibold z-10 border-r border-base-content/20 h-12 flex items-center justify-center"></td>

                        <td th:each="training : ${trainings}" class="text-center p-0 border-l border-base-content/20">

                            <div th:with="attendance=${attendanceMap.get(player.id)?.get(training.id)}">

                                <div th:if="${attendance}"
                                     th:attr="data-player-id=${player.id},
                                          data-training-id=${training.id},
                                          data-current-status=${attendance.status}"
                                     th:text="${statusDescriptions.get(attendance.status.name())}"
                                     th:classappend="'status-' + ${attendance.status}"
                                     class="editable-cell h-12 w-full !h-full flex items-center justify-center text-xs font-semibold transition-colors duration-150">
                                </div>

                                <div th:unless="${attendance}"
                                     th:attr="data-player-id=${player.id},
                                          data-training-id=${training.id},
                                          data-current-status='INDEFINIDO'"
                                     th:text="${statusDescriptions.get('INDEFINIDO')}"
                                     th:classappend="'status-INDEFINIDO'"
                                     class="editable-cell h-12 w-full !h-full flex items-center justify-center text-xs font-semibold transition-colors duration-150">
                                </div>

                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<script th:inline="javascript">
    const STATUS_CYCLE = {
        'INDEFINIDO': 'PRESENTE',
        'PRESENTE': 'AUSENTE',
        'AUSENTE': 'NAO_ERA',
        'NAO_ERA': 'INDEFINIDO'
    };

    const STATUS_DESCRIPTIONS = {
        'PRESENTE': /*[[#{attendance.grid.status.present}]]*/ 'presente',
        'AUSENTE': /*[[#{attendance.grid.status.absent}]]*/ 'ausente',
        'NAO_ERA': /*[[#{attendance.grid.status.not-applicable}]]*/ 'não era',
        'INDEFINIDO': /*[[#{attendance.grid.status.undefined}]]*/ 'indefinido'
    };

    const API_URL = '/api/attendance';

    let lastSortedColumn = -1;
    let sortDirection = 1;

    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.editable-cell').forEach(cell => {
            cell.addEventListener('click', function() {
                const playerId = this.getAttribute('data-player-id');
                const trainingId = this.getAttribute('data-training-id');
                const currentStatus = this.getAttribute('data-current-status');

                const nextStatus = STATUS_CYCLE[currentStatus];

                this.classList.remove('status-' + currentStatus);
                this.classList.add('status-' + nextStatus);
                this.textContent = STATUS_DESCRIPTIONS[nextStatus];
                this.setAttribute('data-current-status', nextStatus);

                updateAttendance(playerId, trainingId, nextStatus, this);
            });
        });

        sortTable(0);
    });

    function updateAttendance(playerId, trainingId, newStatus, cellElement) {
        const payload = {
            playerId: playerId,
            trainingId: trainingId,
            newStatus: newStatus
        };

        fetch(API_URL, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        })
            .then(response => {
                if (!response.ok) {
                    alert('Erro ao salvar presença. Tente novamente.');
                    revertCell(cellElement);
                }
            })
            .catch(error => {
                console.error('Erro na rede:', error);
                alert('Erro de conexão ao salvar presença.');
                revertCell(cellElement);
            });
    }

    function revertCell(cellElement) {
        const currentStatus = cellElement.getAttribute('data-current-status');

        const prevStatus = Object.keys(STATUS_CYCLE).find(key => STATUS_CYCLE[key] === currentStatus);

        if (prevStatus) {
            cellElement.classList.remove('status-' + currentStatus);
            cellElement.classList.add('status-' + prevStatus);
            cellElement.textContent = STATUS_DESCRIPTIONS[prevStatus];
            cellElement.setAttribute('data-current-status', prevStatus);
        }
    }

    function filterPlayerNames() {
        const input = document.getElementById('filter-player-name');
        const filter = input.value.toUpperCase();

        const tbody = document.querySelector('.table tbody');
        const rows = tbody.getElementsByTagName('tr');

        for (let i = 0; i < rows.length; i++) {
            const nameCell = rows[i].getElementsByTagName('td')[0];

            if (nameCell) {
                const nameValue = nameCell.textContent || nameCell.innerText;

                if (nameValue.toUpperCase().indexOf(filter) > -1) {
                    rows[i].style.display = '';
                } else {
                    rows[i].style.display = 'none';
                }
            }
        }
    }

    function getStatusWeight(statusText) {
        switch (statusText.toUpperCase()) {
            case 'PRESENTE': return 1;
            case 'AUSENTE': return 2;
            case 'NÃO ERA': return 3;
            case 'INDEFINIDO': return 4;
            default: return 99;
        }
    }

    function sortTable(n) {
        const table = document.getElementById("attendance-table");
        const tbody = table.querySelector('tbody');
        let rows = tbody.rows;
        let switching = true;
        let i, x, y, shouldSwitch;

        if (lastSortedColumn === n) {
            sortDirection = sortDirection * -1;
        } else {
            sortDirection = 1;
        }
        lastSortedColumn = n;

        const allArrows = document.querySelectorAll('.sort-icon');
        allArrows.forEach(arrow => arrow.textContent = '');

        const arrow = document.getElementById('sort-arrow-' + n);
        if (arrow) {
            arrow.textContent = sortDirection === 1 ? '▲' : '▼';
        }

        while (switching) {
            switching = false;

            for (i = 0; i < (rows.length - 1); i++) {
                shouldSwitch = false;

                x = rows[i].getElementsByTagName("td")[n];
                y = rows[i + 1].getElementsByTagName("td")[n];

                const xTie = rows[i].getElementsByTagName("td")[0];
                const yTie = rows[i + 1].getElementsByTagName("td")[0];

                let xValue, yValue, xTieValue, yTieValue;

                if (n > 0) {
                    xValue = getStatusWeight(x.querySelector('.editable-cell').textContent);
                    yValue = getStatusWeight(y.querySelector('.editable-cell').textContent);
                } else {
                    xValue = x.textContent.toLowerCase();
                    yValue = y.textContent.toLowerCase();
                }

                xTieValue = xTie.textContent.toLowerCase();
                yTieValue = yTie.textContent.toLowerCase();


                let compareValue = 0;

                if (xValue > yValue) {
                    compareValue = 1;
                } else if (xValue < yValue) {
                    compareValue = -1;
                }

                if (compareValue === 0) {
                    if (xTieValue > yTieValue) {
                        compareValue = 1;
                    } else if (xTieValue < yTieValue) {
                        compareValue = -1;
                    }
                }

                if (sortDirection === 1) {
                    if (compareValue > 0) {
                        shouldSwitch = true;
                        break;
                    }
                } else if (sortDirection === -1) {
                    if (compareValue < 0) {
                        shouldSwitch = true;
                        break;
                    }
                }
            }
            if (shouldSwitch) {
                rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                switching = true;
            }
        }
    }
</script>
</body>
</html>